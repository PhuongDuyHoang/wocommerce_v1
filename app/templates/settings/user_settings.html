{% extends "base.html" %}

{% block styles %}
<style>
    .variable-guide {
        font-size: 0.85em;
        background-color: #f8f9fa;
        border-radius: 4px;
        padding: 10px;
        border: 1px solid #dee2e6;
    }
    .variable-guide code {
        background-color: #e9ecef;
        padding: 2px 4px;
        border-radius: 3px;
        color: #d63384;
    }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
</div>

<div class="row">
    <div class="col-lg-7">
        <form action="{{ url_for('settings.personal') }}" method="post" novalidate>
            {{ form.hidden_tag() }}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                    <h5 class="mb-0"><i class="bi bi-telegram me-2"></i>Cài đặt Telegram Cá nhân</h5>
                </div>
                <div class="card-body">
                    <p class="text-muted">Các cài đặt tại đây sẽ được ưu tiên sử dụng thay cho cài đặt của hệ thống để gửi thông báo cho riêng bạn.</p>
                    <div class="mb-3">
                        {{ form.telegram_bot_token.label(class="form-label") }}
                        {{ form.telegram_bot_token(class="form-control", placeholder="Để trống nếu muốn dùng Bot của hệ thống") }}
                    </div>
                    <div class="mb-3">
                        {{ form.telegram_chat_id.label(class="form-label") }}
                        {{ form.telegram_chat_id(class="form-control", placeholder="Nhập ID kênh chat của riêng bạn") }}
                    </div>
                    <div class="form-check mb-3">
                        {{ form.telegram_enabled(class="form-check-input") }}
                        {{ form.telegram_enabled.label(class="form-check-label") }}
                    </div>

                    {% if current_user.can_customize_telegram_delay %}
                    <hr>
                    <div class="mb-3">
                        {{ form.telegram_send_delay_seconds.label(class="form-label") }}
                        {{ form.telegram_send_delay_seconds(class="form-control") }}
                        <div class="form-text">Ghi đè độ trễ gửi tin nhắn mặc định của hệ thống.</div>
                    </div>
                    {% endif %}
                </div>
            </div>


            {% if current_user.can_customize_telegram_templates %}
            <div class="card shadow-sm mb-4">
                <div class="card-header">
                     <h5 class="mb-0"><i class="bi bi-file-text-fill me-2"></i>Cấu hình Template Cá nhân</h5>
                </div>
                <div class="card-body">
                    <div class="mb-3">
                        {{ form.telegram_template_new_order.label(class="form-label") }}
                        {{ form.telegram_template_new_order(class="form-control", rows=12) }}
                        <div class="form-text">Để trống để sử dụng template mặc định của hệ thống.</div>
                    </div>
                    
                    <div class="variable-guide mt-2">
                        <strong><i class="bi bi-info-circle-fill"></i> Hướng dẫn các biến:</strong>
                        {% raw %}
                        <ul class="mb-0 mt-2 ps-4">
                           <li><code>{{ store_name }}</code>: Tên cửa hàng có đơn hàng.</li>
                            <li><code>{{ order_id }}</code>: Mã đơn hàng của WooCommerce.</li>
                            <li><code>{{ customer_name }}</code>: Tên đầy đủ của khách hàng.</li>
                            <li><code>{{ total_amount }}</code>: Tổng giá trị đơn hàng (đã định dạng).</li>
                            <li><code>{{ currency }}</code>: Đơn vị tiền tệ (VD: USD).</li>
                            <li><code>{{ status }}</code>: Trạng thái đơn hàng (VD: processing).</li>
                            <li><code>{{ payment_method }}</code>: Phương thức thanh toán.</li>
                            <li><code>{{ product_list }}</code>: Danh sách sản phẩm trong đơn hàng (đã định dạng).</li>
                        </ul>
                        {% endraw %}
                    </div>
                </div>
                <div class="card-footer d-flex justify-content-end align-items-center bg-light">
                     <button type="button" class="btn btn-outline-info me-auto" id="test-personal-template-btn" data-url="{{ url_for('settings.test_personal_new_order_template') }}">
                        <i class="bi bi-send-check"></i> Kiểm tra Template
                    </button>
                </div>
            </div>
            {% endif %}

            <div class="d-flex justify-content-end">
                {{ form.submit(class="btn btn-primary btn-lg") }}
            </div>
        </form>
    </div>

    <div class="col-lg-5">
        <div class="card shadow-sm mb-4">
             <div class="card-body">
                <h5 class="card-title">Kiểm tra Telegram</h5>
                <p class="text-muted small">Nhấn nút để gửi tin nhắn thử đến kênh cá nhân của bạn. Hãy lưu cài đặt trước khi thử.</p>
                <form action="{{ url_for('settings.test_personal_telegram') }}" method="POST">
                    <button type="submit" class="btn btn-outline-info" 
                        {% if not current_user.telegram_enabled or not current_user.telegram_chat_id %}
                            disabled title="Vui lòng bật và điền Chat ID trước khi thử"
                        {% endif %}>
                        <i class="bi bi-send-check"></i> Gửi tin nhắn thử
                    </button>
                </form>
            </div>
        </div>
    </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const testBtn = document.getElementById('test-personal-template-btn');
    if (testBtn) {
        testBtn.addEventListener('click', function() {
            const url = this.dataset.url;
            const templateTextarea = document.getElementById('telegram_template_new_order');
            const templateContent = templateTextarea.value;

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border spinner-border-sm" role="status" aria-hidden="true"></span> Đang gửi...';

            fetch(url, {
                method: 'POST',
                headers: {
                    'Content-Type': 'application/x-www-form-urlencoded',
                },
                body: new URLSearchParams({
                    'template_content': templateContent
                })
            })
            .then(response => response.json())
            .then(data => {
                alert(data.message);
            })
            .catch(error => {
                alert('Lỗi kết nối: ' + error);
            })
            .finally(() => {
                this.disabled = false;
                this.innerHTML = '<i class="bi bi-send-check"></i> Kiểm tra Template';
            });
        });
    }
});
</script>
{% endblock %}