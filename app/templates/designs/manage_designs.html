{% extends "base.html" %}

{% block styles %}
<style>
    /* START: CSS MỚI CHO BỐ CỤC CỐ ĐỊNH HEADER */
    .content-wrapper {
        display: flex;
        flex-direction: column;
        height: calc(100vh - 56px - 40px);
    }
    .header-content {
        flex-shrink: 0;
    }
    .table-responsive {
        flex-grow: 1;
        overflow-y: auto;
        border: 1px solid #dee2e6;
        border-radius: .375rem;
    }
    .table-responsive thead th {
        position: -webkit-sticky;
        position: sticky;
        top: 0;
        z-index: 10;
        background-color: #f8f9fa;
        box-shadow: inset 0 -2px 0 #dee2e6;
    }
    .pagination-content {
        flex-shrink: 0;
        padding-top: 1rem;
    }
    /* END: CSS MỚI */


    /* === START: SỬA LỖI - Thêm nền xám cho ảnh thu nhỏ === */
    .design-image {
        width: 100px;
        height: 100px;
        object-fit: contain;
        background-color: #f8f9fa; /* Thêm lại nền xám nhạt */
        border: 1px solid #dee2e6;  /* Thêm lại đường viền */
        border-radius: 4px;         /* Bo góc cho đẹp */
        padding: 5px;               /* Thêm khoảng đệm */
        cursor: pointer;
        transition: transform 0.2s;
    }
    /* === END: SỬA LỖI === */

    .design-image:hover {
        transform: scale(1.05);
    }
    .action-buttons .btn {
        width: 38px;
    }
    #bulk-actions-container {
        display: none;
    }
    .form-error {
        color: #dc3545;
        font-size: 0.875em;
        margin-top: 0.25rem;
    }
    #imageModal .modal-content {
        background-color: transparent;
        border: none;
        box-shadow: none;
    }
    #imageModal .modal-body {
        padding: 0;
    }
    #imageModal .modal-header {
        position: absolute;
        top: -1.5rem;
        right: -1.5rem;
        z-index: 10;
        border-bottom: 0;
    }
    #modalImage {
        width: 100%;
        height: auto;
        border-radius: 8px;
    }
</style>
{% endblock %}

{% block content %}
<div class="content-wrapper">
    <div class="header-content">
        <div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
            <h1 class="h2">{{ title }}</h1>
        </div>

        <div class="card shadow-sm mb-3">
            <div class="card-body p-3">
                <div class="row align-items-center g-2">
                    <div class="col-md-4">
                        <form action="{{ url_for('designs.manage') }}" method="GET">
                            <div class="input-group">
                                <input type="text" class="form-control" name="search_query" placeholder="Tìm tên design..." value="{{ search_query or '' }}">
                                <button class="btn btn-outline-secondary" type="submit"><i class="bi bi-search"></i></button>
                            </div>
                        </form>
                    </div>
                    <div class="col-md-8 text-md-end">
                        <div id="bulk-actions-container" class="btn-group me-2" role="group">
                            <button type="button" class="btn btn-sm btn-danger" id="delete-selected-btn">
                                <i class="bi bi-trash-fill"></i> Xóa đã chọn (<span id="selected-count">0</span>)
                            </button>
                        </div>
                        <button class="btn btn-primary" id="create-design-btn">
                            <i class="bi bi-plus-circle-fill"></i> Thêm Design
                        </button>
                    </div>
                </div>
            </div>
        </div>
    </div>

    <div class="table-responsive">
        <table class="table table-hover align-middle mb-0">
            <thead class="table-light">
                <tr>
                    <th style="width: 5%;" class="text-center"><input class="form-check-input" type="checkbox" id="select-all-checkbox"></th>
                    <th style="width: 50%;">Tên Design</th>
                    <th style="width: 25%;" class="text-center">Hình ảnh</th>
                    <th style="width: 20%;" class="text-center">Hành động</th>
                </tr>
            </thead>
            <tbody>
                {% for design in designs.items %}
                <tr id="design-row-{{ design.id }}">
                    <td class="text-center"><input class="form-check-input row-checkbox" type="checkbox" value="{{ design.id }}"></td>
                    <td>{{ design.name }}</td>
                    <td class="text-center">
                        <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-large-src="{{ design.image_url }}">
                            <img src="{{ design.image_url }}" alt="{{ design.name }}" class="design-image" onerror="this.parentElement.innerHTML = 'Không thể tải ảnh';">
                        </a>
                        <a href="{{ design.image_url }}" target="_blank" class="d-block mt-1 small">Link</a>
                    </td>
                    <td class="text-center action-buttons">
                        <button class="btn btn-sm btn-outline-secondary edit-btn"
                                data-id="{{ design.id }}"
                                title="Chỉnh sửa">
                            <i class="bi bi-pencil-fill"></i>
                        </button>
                        <button class="btn btn-sm btn-outline-danger delete-btn"
                                data-id="{{ design.id }}"
                                title="Xóa">
                            <i class="bi bi-trash-fill"></i>
                        </button>
                    </td>
                </tr>
                {% else %}
                <tr>
                    <td colspan="4" class="text-center text-muted py-4">Không có design nào.</td>
                </tr>
                {% endfor %}
            </tbody>
        </table>
    </div>

    {% if designs.pages > 1 %}
    <div class="pagination-content">
        <nav aria-label="Design navigation">
            <ul class="pagination justify-content-center mb-0">
                <li class="page-item {% if not designs.has_prev %}disabled{% endif %}"><a class="page-link" href="{{ url_for('designs.manage', page=designs.prev_num, search_query=search_query) }}">«</a></li>
                {% for page_num in designs.iter_pages(left_edge=1, right_edge=1, left_current=2, right_current=2) %}
                    {% if page_num %}
                        <li class="page-item {% if page_num == designs.page %}active{% endif %}"><a class="page-link" href="{{ url_for('designs.manage', page=page_num, search_query=search_query) }}">{{ page_num }}</a></li>
                    {% else %}
                        <li class="page-item disabled"><span class="page-link">...</span></li>
                    {% endif %}
                {% endfor %}
                <li class="page-item {% if not designs.has_next %}disabled{% endif %}"><a class="page-link" href="{{ url_for('designs.manage', page=designs.next_num, search_query=search_query) }}">»</a></li>
            </ul>
        </nav>
    </div>
    {% endif %}
</div>
<div class="modal fade" id="designModal" tabindex="-1" aria-labelledby="designModalLabel" aria-hidden="true">
    <div class="modal-dialog">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="designModalLabel">Thêm Design mới</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <form id="designForm" novalidate>
                <div class="modal-body">
                    <input type="hidden" id="designId" name="design_id">
                    {{ form.hidden_tag() }}
                    <div class="mb-3">
                        {{ form.name.label(class="form-label") }}
                        {{ form.name(class="form-control", id="designName") }}
                        <div id="name-error" class="form-error"></div>
                    </div>
                    <div class="mb-3">
                        {{ form.image_url.label(class="form-label") }}
                        {{ form.image_url(class="form-control", id="designImageUrl", placeholder="Dán link Google Drive share vào đây") }}
                        <div id="image_url-error" class="form-error"></div>
                    </div>
                </div>
                <div class="modal-footer">
                    <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                    <button type="submit" class="btn btn-primary" id="submitDesignBtn">Tạo</button>
                </div>
            </form>
        </div>
    </div>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-header">
        <button type="button" class="btn-close btn-close-white" data-bs-dismiss="modal" aria-label="Close"></button>
      </div>
      <div class="modal-body text-center">
        <img src="" class="img-fluid" id="modalImage" alt="Hình ảnh design">
      </div>
    </div>
  </div>
</div>

<div class="modal fade" id="confirmDeleteModal" tabindex="-1" aria-labelledby="confirmDeleteModalLabel" aria-hidden="true">
    <div class="modal-dialog modal-dialog-centered">
        <div class="modal-content">
            <div class="modal-header">
                <h5 class="modal-title" id="confirmDeleteModalLabel">Xác nhận Xóa</h5>
                <button type="button" class="btn-close" data-bs-dismiss="modal" aria-label="Close"></button>
            </div>
            <div class="modal-body" id="confirmDeleteModalBody">
                Bạn có chắc chắn muốn thực hiện hành động này?
            </div>
            <div class="modal-footer">
                <button type="button" class="btn btn-secondary" data-bs-dismiss="modal">Hủy</button>
                <button type="button" class="btn btn-danger" id="confirmDeleteBtn">Xóa</button>
            </div>
        </div>
    </div>
</div>

{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const confirmDeleteModalEl = document.getElementById('confirmDeleteModal');
    const confirmDeleteModal = new bootstrap.Modal(confirmDeleteModalEl);
    const confirmDeleteBtn = document.getElementById('confirmDeleteBtn');
    let actionToConfirm = null;

    function showToast(message, category = 'info') {
        const toastContainer = document.querySelector('.toast-container');
        if (!toastContainer) return;
        let bgColor = 'bg-primary';
        if (category === 'success') bgColor = 'bg-success';
        if (category === 'danger') bgColor = 'bg-danger';
        const toastEl = document.createElement('div');
        toastEl.className = `toast align-items-center text-white ${bgColor} border-0`;
        toastEl.setAttribute('role', 'alert');
        toastEl.innerHTML = `<div class="d-flex"><div class="toast-body">${message}</div><button type="button" class="btn-close btn-close-white me-2 m-auto" data-bs-dismiss="toast"></button></div>`;
        toastContainer.appendChild(toastEl);
        const toast = new bootstrap.Toast(toastEl, { delay: 5000 });
        toast.show();
        toastEl.addEventListener('hidden.bs.toast', () => toastEl.remove());
    }

    const designModalEl = document.getElementById('designModal');
    const designModal = new bootstrap.Modal(designModalEl);
    const designForm = document.getElementById('designForm');
    const modalLabel = document.getElementById('designModalLabel');
    const submitBtn = document.getElementById('submitDesignBtn');
    const designImageUrlInput = document.getElementById('designImageUrl');
    const tableBody = document.querySelector('tbody');
    const designIdInput = document.getElementById('designId');

    document.getElementById('create-design-btn').addEventListener('click', function() {
        modalLabel.textContent = 'Thêm Design mới';
        submitBtn.textContent = 'Tạo';
        designForm.action = "{{ url_for('designs.add') }}";
        designIdInput.value = '';
        designForm.reset();
        clearErrors();
        designModal.show();
    });

    tableBody.addEventListener('click', async function(e) {
        const editBtn = e.target.closest('.edit-btn');
        const deleteBtn = e.target.closest('.delete-btn');

        if (editBtn) {
            const designId = editBtn.dataset.id;
            clearErrors();
            const response = await fetch(`/designs/details/${designId}`);
            const data = await response.json();
            if (data.success) {
                modalLabel.textContent = 'Chỉnh sửa Design';
                submitBtn.textContent = 'Lưu thay đổi';
                designForm.action = `/designs/edit/${designId}`;
                document.getElementById('designName').value = data.name;
                designImageUrlInput.value = data.image_url;
                designIdInput.value = designId;
                designModal.show();
            } else {
                showToast('Không thể tải dữ liệu design.', 'danger');
            }
        }

        if (deleteBtn) {
            const designId = deleteBtn.dataset.id;
            document.getElementById('confirmDeleteModalBody').textContent = 'Bạn có chắc chắn muốn xóa design này?';

            actionToConfirm = async () => {
                const response = await fetch(`/designs/delete/${designId}`, { method: 'POST' });
                const data = await response.json();
                if (data.success) {
                    document.getElementById(`design-row-${designId}`).remove();
                    showToast(data.message, 'success');
                } else {
                    showToast('Xóa thất bại.', 'danger');
                }
            };

            confirmDeleteModal.show();
        }
    });

    designForm.addEventListener('submit', async function(e) {
        e.preventDefault();
        clearErrors();
        const response = await fetch(this.action, { method: 'POST', body: new FormData(this) });
        const data = await response.json();
        if (data.success) {
            designModal.hide();
            window.location.reload();
        } else if (data.errors) {
            for (const field in data.errors) {
                const errorDiv = document.getElementById(`${field}-error`);
                if (errorDiv) { errorDiv.textContent = data.errors[field][0]; }
            }
        }
    });

    function clearErrors() {
        document.querySelectorAll('.form-error').forEach(el => el.textContent = '');
    }

    confirmDeleteBtn.addEventListener('click', function() {
        if (typeof actionToConfirm === 'function') {
            actionToConfirm();
            actionToConfirm = null;
        }
        confirmDeleteModal.hide();
    });

    const selectAllCheckbox = document.getElementById('select-all-checkbox');
    const rowCheckboxes = document.querySelectorAll('.row-checkbox');
    const bulkActionsContainer = document.getElementById('bulk-actions-container');
    const selectedCountSpan = document.getElementById('selected-count');
    const deleteSelectedBtn = document.getElementById('delete-selected-btn');

    function updateBulkActionsVisibility() {
        const checkedCount = document.querySelectorAll('.row-checkbox:checked').length;
        if (checkedCount > 0) {
            bulkActionsContainer.style.display = 'inline-block';
            selectedCountSpan.textContent = checkedCount;
        } else {
            bulkActionsContainer.style.display = 'none';
        }
    }

    if (selectAllCheckbox) {
        selectAllCheckbox.addEventListener('change', function() {
            rowCheckboxes.forEach(cb => cb.checked = this.checked);
            updateBulkActionsVisibility();
        });
    }

    tableBody.addEventListener('change', (e) => {
        if (e.target.classList.contains('row-checkbox')) {
            updateBulkActionsVisibility();
        }
    });

    if (deleteSelectedBtn) {
        deleteSelectedBtn.addEventListener('click', async function() {
            const selectedIds = Array.from(document.querySelectorAll('.row-checkbox:checked')).map(cb => cb.value);
            if (selectedIds.length === 0) return;

            document.getElementById('confirmDeleteModalBody').textContent = `Bạn có chắc muốn xóa vĩnh viễn ${selectedIds.length} design đã chọn?`;

            actionToConfirm = async () => {
                const response = await fetch("{{ url_for('designs.delete_selected') }}", {
                    method: 'POST',
                    headers: {'Content-Type': 'application/json'},
                    body: JSON.stringify({ ids: selectedIds })
                });
                const data = await response.json();
                if (data.success) {
                    showToast(data.message, 'success');
                    setTimeout(() => window.location.reload(), 1500);
                } else {
                    showToast('Lỗi khi xóa: ' + data.message, 'danger');
                }
            };

            confirmDeleteModal.show();
        });
    }

    designImageUrlInput.addEventListener('input', function() {
        const url = this.value;
        const regex = /drive\.google\.com\/file\/d\/([a-zA-Z0-9_-]+)/;
        const match = url.match(regex);
        if (match && match[1]) {
            const fileId = match[1];
            // === START: SỬA LỖI - Dùng đúng định dạng link googleusercontent theo yêu cầu ===
            this.value = `https://lh3.googleusercontent.com/d/${fileId}`;
            // === END: SỬA LỖI ===
        }
    });

    const imageModal = document.getElementById('imageModal');
    if (imageModal) {
        imageModal.addEventListener('show.bs.modal', function (event) {
            const triggerElement = event.relatedTarget;
            const largeImageUrl = triggerElement.getAttribute('data-large-src');
            const modalImage = imageModal.querySelector('#modalImage');
            modalImage.src = largeImageUrl;
        });
    }
});
</script>
{% endblock %}