{% extends "base.html" %}

{% block styles %}
<style>
    .table th {
        vertical-align: middle;
        text-align: center; 
    }
    .table td { 
        vertical-align: middle;
        overflow-wrap: break-word;
        word-break: break-word;
    }
    .product-list { 
        list-style-type: none; 
        padding-left: 0; 
        margin-bottom: 0; 
        font-size: 0.9em;
    }
    .product-list li {
        display: flex;
        align-items: flex-start;
        padding-bottom: 8px;
        margin-bottom: 8px;
        border-bottom: 1px dashed #eee;
    }
    .product-list li:last-child {
        border-bottom: none;
        padding-bottom: 0;
        margin-bottom: 0;
    }
    .variations-text {
        color: #6c757d;
        font-size: 0.9em;
        font-style: italic;
    }
    .sku-text {
        font-weight: 500;
        color: #495057;
    }
    .product-image {
        width: 80px;
        height: 80px;
        object-fit: cover;
        border-radius: 4px;
        cursor: pointer;
        transition: transform 0.2s;
        margin-right: 12px;
        flex-shrink: 0;
    }
    .product-image-placeholder {
        width: 80px;
        height: 80px;
        background-color: #f8f9fa;
        border: 1px dashed #dee2e6;
        border-radius: 4px;
        margin-right: 12px;
        flex-shrink: 0;
    }
    .product-image:hover {
        transform: scale(1.1);
    }
    #imageModal .modal-content {
        background-color: transparent;
        border: none;
    }
    #imageModal .modal-body {
        padding: 0;
    }
    #modalImage {
        width: 100%;
        height: auto;
        border-radius: 8px;
    }

    .td-note-cell {
        position: relative;
        padding: 0 !important;
    }
    .note-wrapper {
        position: absolute;
        top: 0;
        left: 0;
        width: 100%;
        height: 100%;
        display: flex;
        flex-direction: column;
    }
    .order-note-textarea {
        flex-grow: 1;
        width: 100%;
        border: none;
        border-radius: 0;
        resize: none;
        background-color: transparent;
        padding: 8px;
        transition: background-color 0.2s ease-in-out;
    }
    .order-note-textarea:hover {
        background-color: #f8f9fa;
    }
    .order-note-textarea:focus {
        background-color: #fff;
        box-shadow: inset 0 0 0 2px #0d6efd;
    }
    .save-status {
        position: absolute;
        bottom: 8px;
        right: 8px;
        font-size: 0.7em;
        padding: 2px 5px;
        border-radius: 4px;
        color: white;
        opacity: 0;
        transition: opacity 0.3s ease-in-out;
        pointer-events: none;
    }
    .save-status.show { opacity: 1; }
    .save-status.saving { background-color: #0dcaf0; }
    .save-status.saved { background-color: #198754; }
    .save-status.error { background-color: #dc3545; }

    .status-update-form {
        display: flex;
        align-items: center;
        gap: 8px;
        min-width: 200px;
    }
    .status-select {
        flex-grow: 1;
        font-weight: 500;
    }
    .status-save-btn .spinner-border {
        width: 1rem;
        height: 1rem;
        border-width: .2em;
    }

    .status-select.status-processing { background-color: #84af77; color: white; }
    .status-select.status-completed { background-color: #77a4b4; color: white; }
    .status-select.status-on-hold { background-color: #f8b44e; color: white; }
    .status-select.status-failed { background-color: #d65d5d; color: white; }
    .status-select.status-cancelled { background-color: #a4a9ac; color: white; }
    .status-select.status-refunded { background-color: #555; color: white; }
    .status-select.status-pending { background-color: #e9ecef; color: #333; }
</style>
{% endblock %}

{% block content %}
<div class="d-flex justify-content-between flex-wrap flex-md-nowrap align-items-center pt-3 pb-2 mb-3 border-bottom">
    <h1 class="h2">{{ title }}</h1>
</div>

<div class="card shadow-sm mb-4">
    <div class="card-body">
        <form id="filters-form" action="{{ url_for('orders.manage_all_orders') }}" method="GET">
            <!-- === SỬA LỖI: TÁCH Ô TÌM KIẾM RA HÀNG RIÊNG === -->
            <div class="row mb-3">
                <div class="col-12">
                    <label for="search_query" class="form-label">Tìm kiếm</label>
                    <input type="text" class="form-control form-control-sm" id="search_query" name="search_query" placeholder="Mã đơn hàng, tên khách, SĐT, email, SKU sản phẩm..." value="{{ search_query or '' }}">
                </div>
            </div>
            
            <div class="row g-2 align-items-end">
                {% if current_user.is_super_admin() %}
                <div class="col-md-2">
                    <label for="admin_id_filter" class="form-label">Lọc theo Admin</label>
                    <select class="form-select form-select-sm" id="admin_id_filter" name="admin_id">
                        <option value="">Tất cả Admin</option>
                        {% for admin in admins_for_filter %}
                            <option value="{{ admin.id }}" {% if admin.id == selected_admin_id %}selected{% endif %}>{{ admin.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                {% if current_user.is_super_admin() or current_user.is_admin() %}
                <div class="col-md-2">
                    <label for="user_id_filter" class="form-label">Lọc theo User</label>
                    <select class="form-select form-select-sm" id="user_id_filter" name="user_id">
                        <option value="">Tất cả User</option>
                        {% for user in users_for_filter %}
                            <option value="{{ user.id }}" {% if user.id == selected_user_id %}selected{% endif %}>{{ user.username }}</option>
                        {% endfor %}
                    </select>
                </div>
                {% endif %}

                <div class="col-md-2"><label for="store_id_filter" class="form-label">Cửa hàng</label><select class="form-select form-select-sm" id="store_id_filter" name="store_id"><option value="">Tất cả</option>{% for store in stores_for_filter %}<option value="{{ store.id }}" {% if store.id == selected_store_id %}selected{% endif %}>{{ store.name }}</option>{% endfor %}</select></div>
                <div class="col-md-2">
                    <label for="status_filter" class="form-label">Trạng thái</label>
                    <select class="form-select form-select-sm" id="status_filter" name="status">
                        <option value="">Tất cả</option>
                        {% for status_val, status_text in statuses %}
                            <option value="{{ status_val }}" {% if status_val == selected_status %}selected{% endif %}>{{ status_text }}</option>
                        {% endfor %}
                    </select>
                </div>
                <div class="col-md-2"><label for="start_date" class="form-label">Từ ngày</label><input type="date" class="form-control form-control-sm" id="start_date" name="start_date" value="{{ start_date or '' }}"></div>
                <div class="col-md-2"><label for="end_date" class="form-label">Đến ngày</label><input type="date" class="form-control form-control-sm" id="end_date" name="end_date" value="{{ end_date or '' }}"></div>
                <div class="col-md-auto ms-auto"><div class="d-flex gap-2"><button type="submit" class="btn btn-primary btn-sm"><i class="bi bi-funnel"></i> Lọc</button><a href="{{ url_for('orders.manage_all_orders') }}" class="btn btn-secondary btn-sm"><i class="bi bi-x-circle"></i> Xóa</a></div></div>
            </div>
        </form>
    </div>
</div>

<div class="table-responsive">
    <table class="table table-hover table-bordered table-sm" style="table-layout: fixed;">
        <thead class="table-light">
            <tr>
                {% for column in columns_config if column.visible and column.key != 'image' %}
                    {% if column.key == 'owner_username' and not (current_user.is_super_admin() or current_user.is_admin()) %}{% else %}
                        <th style="width: {{ column.width or 'auto' }};">{{ column.label }}</th>
                    {% endif %}
                {% endfor %}
            </tr>
        </thead>
        <tbody>
            {% for order in orders %}
            <tr>
                {% for column in columns_config if column.visible and column.key != 'image' %}
                    {% if column.key == 'owner_username' and not (current_user.is_super_admin() or current_user.is_admin()) %}
                    {% else %}
                        <td class="
                            {% if column.type == 'currency' %}text-end fw-bold{% endif %}
                            {% if column.key == 'wc_order_id' %}fw-bold{% endif %}
                            {% if column.type == 'datetime' %}small text-nowrap{% endif %}
                            {% if column.key == 'note' %}td-note-cell{% endif %}
                        ">
                            {% if column.key == 'note' %}
                                <div class="note-wrapper">
                                    <textarea class="order-note-textarea" 
                                              data-order-id="{{ order.id }}" 
                                              data-original-value="{{ order.note or '' }}"
                                              placeholder="Thêm ghi chú...">{{ order.note or '' }}</textarea>
                                    <div class="save-status"></div>
                                </div>
                            {% elif column.key == 'order_created_at' and order.order_created_at %}
                                {{ order.order_created_at.strftime('%d-%m-%Y %H:%M') }}
                            {% elif column.key == 'store_name' %}
                                <div class="text-truncate" title="{{ order.store.name }}">
                                    <a href="{{ url_for('stores.edit', store_id=order.store.id) }}">{{ order.store.name }}</a>
                                </div>
                            {% elif column.key == 'owner_username' %}
                                {% if order.owner_username != 'Chưa gán' %}<span class="badge bg-info text-dark">{{ order.owner_username }}</span>{% else %}<span class="badge bg-secondary">Chưa gán</span>{% endif %}
                            {% elif column.key == 'wc_order_id' %}
                                #{{ order.wc_order_id }}
                            {% elif column.type == 'currency' %}
                                ${{ "{:,.2f}".format(order[column.key] or 0) }}
                            
                            {% elif column.key == 'status' %}
                                <div class="status-update-form">
                                    <select class="form-select form-select-sm status-select status-{{ order.status }}" data-order-id="{{ order.id }}" data-original-status="{{ order.status }}">
                                        {% for status_val, status_text in statuses %}
                                            <option value="{{ status_val }}" {% if order.status == status_val %}selected{% endif %}>
                                                {{ status_text }}
                                            </option>
                                        {% endfor %}
                                    </select>
                                    <button class="btn btn-sm btn-primary status-save-btn" disabled title="Lưu thay đổi">
                                        <i class="bi bi-save"></i>
                                    </button>
                                </div>
                            
                            {% elif column.key == 'products' %}
                                <ul class="product-list">
                                {% for item in order.line_items %}
                                    <li>
                                        {% if item.image_url %}
                                            <a href="#" data-bs-toggle="modal" data-bs-target="#imageModal" data-large-src="{{ item.image_url }}">
                                                <img src="{{ item.image_url }}" alt="{{ item.product_name }}" class="product-image">
                                            </a>
                                        {% else %}
                                            <div class="product-image-placeholder"></div>
                                        {% endif %}
                                        <div>
                                            <strong class="d-block" title="{{ item.product_name }}">{{ item.product_name }}</strong>
                                            <span>(SL: {{ item.quantity }})</span>
                                            <br><span class="sku-text">SKU: {{ item.sku or 'N/A' }}</span>
                                            {% set variations = item.variations_list %}
                                            {% if variations %}
                                            <br><span class="variations-text">{{ variations | join(' | ') }}</span>
                                            {% endif %}
                                        </div>
                                    </li>
                                {% endfor %}
                                </ul>
                            {% else %}
                                <div title="{{ order[column.key] or '' }}">
                                    {{ order[column.key] or '' }}
                                </div>
                            {% endif %}
                        </td>
                    {% endif %}
                {% endfor %}
            </tr>
            {% else %}
                {% set visible_columns = columns_config | selectattr('visible') | rejectattr('key', 'equalto', 'image') | list %}
                {% set colspan = visible_columns|length %}
                {% if not (current_user.is_super_admin() or current_user.is_admin()) %}
                    {% for col in visible_columns if col.key == 'owner_username' %}
                        {% set colspan = colspan - 1 %}
                    {% endfor %}
                {% endif %}
                <tr><td colspan="{{ colspan }}" class="text-center text-muted py-4">Không tìm thấy đơn hàng nào phù hợp với bộ lọc.</td></tr>
            {% endfor %}
        </tbody>
    </table>
</div>

<div class="modal fade" id="imageModal" tabindex="-1" aria-labelledby="imageModalLabel" aria-hidden="true">
  <div class="modal-dialog modal-lg modal-dialog-centered">
    <div class="modal-content">
      <div class="modal-body text-center">
        <img src="" class="img-fluid" id="modalImage" alt="Hình ảnh sản phẩm">
      </div>
    </div>
  </div>
</div>
{% endblock %}

{% block scripts %}
<script>
document.addEventListener('DOMContentLoaded', function() {
    const adminFilter = document.getElementById('admin_id_filter');
    const userFilter = document.getElementById('user_id_filter');
    const form = document.getElementById('filters-form');

    if (adminFilter) {
        adminFilter.addEventListener('change', function() {
            if (userFilter) {
                userFilter.value = ""; 
            }
            form.submit();
        });
    }

    const imageModal = document.getElementById('imageModal');
    if (imageModal) {
        imageModal.addEventListener('show.bs.modal', function (event) {
            const triggerElement = event.relatedTarget;
            const largeImageUrl = triggerElement.getAttribute('data-large-src');
            const modalImage = imageModal.querySelector('#modalImage');
            modalImage.src = largeImageUrl;
        });
    }

    const noteTextareas = document.querySelectorAll('.order-note-textarea');
    noteTextareas.forEach(textarea => {
        textarea.addEventListener('blur', function() {
            const orderId = this.dataset.orderId;
            const originalValue = this.dataset.originalValue;
            const newValue = this.value;
            const statusDiv = this.parentElement.querySelector('.save-status');
            if (originalValue.trim() === newValue.trim()) { return; }
            statusDiv.textContent = 'Đang lưu...';
            statusDiv.className = 'save-status saving show';
            fetch(`/orders/update_note/${orderId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ note: newValue })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    this.dataset.originalValue = newValue;
                    statusDiv.textContent = 'Đã lưu!';
                    statusDiv.className = 'save-status saved show';
                } else {
                    throw new Error(data.message || 'Lỗi không xác định.');
                }
            })
            .catch(error => {
                statusDiv.textContent = 'Lỗi!';
                statusDiv.className = 'save-status error show';
                this.value = originalValue;
                alert('Lỗi khi lưu ghi chú: ' + error.message);
            })
            .finally(() => {
                setTimeout(() => { statusDiv.classList.remove('show'); }, 2000);
            });
        });
    });

    const statusSelects = document.querySelectorAll('.status-select');
    const allStatusClasses = ['status-processing', 'status-completed', 'status-on-hold', 'status-failed', 'status-cancelled', 'status-refunded', 'status-pending'];

    statusSelects.forEach(select => {
        select.addEventListener('change', function() {
            const originalStatus = this.dataset.originalStatus;
            const newStatus = this.value;
            const saveBtn = this.nextElementSibling;
            saveBtn.disabled = (originalStatus === newStatus);
            this.classList.remove(...allStatusClasses);
            this.classList.add(`status-${newStatus}`);
        });
    });

    const saveButtons = document.querySelectorAll('.status-save-btn');
    saveButtons.forEach(btn => {
        btn.addEventListener('click', function() {
            const select = this.previousElementSibling;
            const orderId = select.dataset.orderId;
            const newStatus = select.value;
            const originalHtml = this.innerHTML;

            this.disabled = true;
            this.innerHTML = '<span class="spinner-border" role="status"></span>';

            fetch(`/orders/update_status/${orderId}`, {
                method: 'POST',
                headers: { 'Content-Type': 'application/json' },
                body: JSON.stringify({ status: newStatus })
            })
            .then(response => response.json().then(data => ({ ok: response.ok, data })))
            .then(({ ok, data }) => {
                if (ok && data.success) {
                    select.dataset.originalStatus = data.new_status;
                    alert('Cập nhật trạng thái thành công!');
                } else {
                    throw new Error(data.message || 'Lỗi không xác định từ server.');
                }
            })
            .catch(error => {
                const originalStatus = select.dataset.originalStatus;
                select.value = originalStatus;
                select.classList.remove(...allStatusClasses);
                select.classList.add(`status-${originalStatus}`);
                alert('Lỗi khi cập nhật trạng thái: ' + error.message);
            })
            .finally(() => {
                this.innerHTML = originalHtml;
                this.disabled = true;
            });
        });
    });
});
</script>
{% endblock %}
